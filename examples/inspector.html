<html>
    <head>
    </head>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"/>
        <script src="https://unpkg.com/pmtiles@latest/index.js"></script>
        <!-- <script src="../js/index.js"></script> -->
        <title>PMTiles inspector</title>
    </head>
    <body class="sans-serif v-scroll bg-dark-gray flex">
        <div class="w-50 vh-100 bg-light-gray pa4 flex flex-column">
            <div class="f4 w-100" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
                <div class=" f4 fw5 dark-gray b--dark-gray ba4 b--dotted bw1 pa3">Drag and drop a local PMTiles file here...</div>
                <div class="pv3">
                    <div class="flex">
                        <input placeholder="PMTiles file url (not yet implemented)" class="flex-grow-1 f6"/>
                        <button class="ml3 link bg-white dim ba pointer">Inspect</button>
                    </div>
                </div>
            </div>
            <div class="fw5 f6 mt2">spec version: <span id="spec_version">?</span></div>
            <div class="fw5 f6 mt2">metadata length: <span id="metadata_length">?</span></div>
            <div id="metadata" class="f6"></div>
            <div class="overflow-y-scroll flex-grow-1 f6 mt2">
                <table class="w-100">
                    <thead class="tl">
                        <tr>
                            <th>z</th>
                            <th>x</th>
                            <th>y</th>
                            <th>offset</th>
                            <th>length</th>
                            <th>dir</th>
                        </tr>
                    </thead>
                    <tbody id="root_entries">
                    </tbody>
                </table>
            </div>
            <div class="f6 mt2"><span id="root_entries_count">?</span> root entries</div>
        </div>
        <div class="w-50 flex items-center justify-center">
            <div>
                <div id="preview_label" class="white mb2"></div>
                <img id="preview"></img>
            </div>
        </div>
    </body>
    <script>
        function loadEntry(file,row) {
            var blob = file.slice(row[3],row[3]+row[4]);
            var imageUrl = window.URL.createObjectURL(blob);
            d3.select("#preview_label").text(`${row[0]} ${row[1]} ${row[2]}`);
            let preview = d3.select("#preview").attr("src",imageUrl);
        }

        function dropHandler(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.items;
            var file = data[0].getAsFile();
            var blob = file.slice(0,512000);
            blob.arrayBuffer().then(a => {
                var header = pmtiles.parseHeader(new DataView(a,0,10));
                let dec = new TextDecoder("utf-8")
                let metadata = JSON.parse(dec.decode(new DataView(a,10,header.json_size)));
                d3.select("#spec_version").text(header.version);
                d3.select("#metadata_length").text(header.json_size);
                d3.select("#root_entries_count").text(header.root_entries);
                d3.select("#metadata").selectAll("div")
                    .data(Object.entries(metadata).map(a => `${a[0]}: ${a[1]}`))
                    .enter().append("div").text(d => d);
                var entries_view = new DataView(a,10+header.json_size,17*header.root_entries);
                let entries = []
                for (var i = 0; i < entries_view.byteLength; i+=17) {
                    entries.push(pmtiles.parseEntry(entries_view,i));
                }
                let row = d3.select("#root_entries").selectAll("tr").data(entries).enter().append("tr")
                    .attr("class","f6 pv1 dim pointer").on("click", (ev,d) => { loadEntry(file, d); });
                row.selectAll("td").data(d => d).enter().append("td").text(d => d);
            })
        }
        function dragOverHandler(ev) {
          ev.preventDefault();
        }

        // const queryString = window.location.search;
        // const urlParams = new URLSearchParams(queryString);
        // const loadUrl = urlParams.get("url");
        // if (loadUrl) {
        //     console.log("load url", loadUrl);
        // }
    </script>
</html>