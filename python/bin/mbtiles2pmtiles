#!/usr/bin/env python

import argparse
import sqlite3
from pmtiles.writer import write

parser = argparse.ArgumentParser(description='Convert an MBTiles archive to PMTiles.')
parser.add_argument('mbtiles_file',help='input MBTiles')
parser.add_argument('pmtiles_file',help='output PMTiles')
parser.add_argument('--maxzoom', help='the maximum zoom level to include in the output.')
args = parser.parse_args()

conn = sqlite3.connect(args.mbtiles_file)
cursor = conn.cursor()

with write(args.pmtiles_file) as writer:
    for row in cursor.execute('SELECT zoom_level,tile_column,tile_row,tile_data FROM tiles WHERE zoom_level <= ? ORDER BY zoom_level,tile_column,tile_row ASC',(args.maxzoom or 99,)):
        writer.write_tile(row[0],row[1],row[2],row[3])

    metadata = {}
    for row in cursor.execute('SELECT name,value FROM metadata'):
        metadata[row[0]] = row[1]
    if args.maxzoom:
        metadata['maxzoom'] = str(args.maxzoom)
    result = writer.finalize(metadata)
    print("Num tiles:",result['num_tiles'])
    print("Num unique tiles:",result['num_unique_tiles'])
    print("Num leaves:",result['num_leaves'])

conn.close()